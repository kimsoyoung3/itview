<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/mainlayout}">
<head>
    <title>IT VIEW ê´€ë¦¬ì í˜ì´ì§€</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .cursor-pointer {
            cursor: pointer;
        }
        .person-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            background-color: #fff;
            /* í…Œë‘ë¦¬ëŠ” ì„ íƒëì„ ë•Œë§Œ ë³´ì´ë„ë¡ ê¸°ë³¸ê°’ì„ ì œê±° */
        }
        .person-photo-container {
            position: relative;
            width: 80px;
            height: 80px;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        .person-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .person-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .person-name {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        .person-role {
            color: #6c757d;
        }
        /* ì„ íƒëœ ì¸ë¬¼ì—ê²Œë§Œ í…Œë‘ë¦¬ê°€ ë³´ì´ë„ë¡ í´ë˜ìŠ¤ ìˆ˜ì • */
        .selected-person {
            border: 2px solid #22c55e;
        }
    </style>
</head>
<body>
<main layout:fragment="content">
    <div class="container mt-3 mb-3">
        <div class="row">
            <div class="col-12 mx-auto" style="max-width: 800px;">
                <h3 class="mt-4" th:text="${contentId != null} ? 'ì½˜í…ì¸  ìˆ˜ì •' : 'ì½˜í…ì¸  ë“±ë¡'"></h3>
                <p class="mt-4">ì½˜í…ì¸ ì— ì°¸ì—¬í•œ ì¸ë¬¼ì„ ë“±ë¡í•©ë‹ˆë‹¤:</p>

                <div class="d-flex justify-content-start mt-4">
                    <button id="showFormBtn" class="btn btn-primary me-1">+ í¬ë ˆë”§ ì¶”ê°€</button>
                </div>

                <div id="creditFormSection" class="mt-4 p-4" style="display:none;">
                    <h5 id="formTitle" class="mb-3">í¬ë ˆë”§ ë“±ë¡</h5>
                    <form id="creditForm" action="#" method="post">
                        <input type="hidden" id="creditId" name="id">
                        <input type="hidden" id="personId" name="person.id">

                        <div class="search-input-group mb-3">
                            <label class="form-label">ì¸ë¬¼ ê²€ìƒ‰</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="personSearchInput" placeholder="ì´ë¦„">
                                <button class="btn btn-primary" type="button" id="personSearchBtn">ê²€ìƒ‰</button>
                            </div>
                        </div>
                        <div id="personSearchResults" class="row mb-3">
                        </div>

                        <div id="fieldsAfterSearch" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">ë¶€ì„œ:</label>
                                <input type="text" class="form-control" id="departmentInput" name="department" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ì—­í• :</label>
                                <input type="text" class="form-control" id="roleInput" name="role" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ìºë¦­í„° ì´ë¦„:</label>
                                <input type="text" class="form-control" id="characterNameInput" name="characterName">
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <button type="submit" class="btn btn-primary me-1" id="saveCreditBtn">ë“±ë¡</button>
                            <button type="button" class="btn btn-primary me-1" id="cancelBtn">ì·¨ì†Œ</button>
                        </div>
                    </form>
                </div>

                <hr class="mt-4">
                <h5 class="mb-3">ë“±ë¡ëœ í¬ë ˆë”§ ëª©ë¡</h5>
                <div id="creditList" class="row">
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <a th:href="@{/content/{contentId}/gallery(contentId=${contentId})}" class="btn btn-primary" th:text="${contentId != null} ? 'ë‹¤ìŒ/ìˆ˜ì •' : 'ë‹¤ìŒ'"></a>
                </div>
            </div>
        </div>

    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const contentId = '[[${contentId}]]';
        const initialCreditList = /*[[${creditList}]]*/ [];
        /*]]>*/

        $(document).ready(function () {
            const creditFormSection = $('#creditFormSection');
            const showFormBtn = $('#showFormBtn');
            const cancelBtn = $('#cancelBtn');
            const personSearchBtn = $('#personSearchBtn');
            const personSearchInput = $('#personSearchInput');
            const personSearchResults = $('#personSearchResults');
            const creditForm = $('#creditForm');
            const formTitle = $('#formTitle');
            const creditIdInput = $('#creditId');
            const personIdInput = $('#personId');
            const departmentInput = $('#departmentInput');
            const roleInput = $('#roleInput');
            const characterNameInput = $('#characterNameInput');
            const saveCreditBtn = $('#saveCreditBtn');
            const creditListContainer = $('#creditList');
            const searchInputGroup = $('.search-input-group');

            const fieldsAfterSearch = $('#fieldsAfterSearch');

            // ì´ˆê¸° ë¡œë”© ì‹œ í¼ ìˆ¨ê¸°ê¸°
            creditFormSection.hide();

            renderCreditList(initialCreditList);

            // 'í¬ë ˆë”§ ì¶”ê°€' ë²„íŠ¼ í´ë¦­ ì‹œ
            showFormBtn.on('click', () => {
                resetForm();
                creditFormSection.slideDown();
                showFormBtn.hide();
                personSearchInput.focus();
            });

            // 'ì·¨ì†Œ' ë²„íŠ¼ í´ë¦­ ì‹œ
            cancelBtn.on('click', () => {
                resetForm();
                creditFormSection.slideUp();
                showFormBtn.show();
            });

            personSearchBtn.on('click', () => {
                searchPersons();
            });

            personSearchInput.on('keydown', function(event) {
                if (event.key === 'Enter' || event.keyCode === 13) {
                    event.preventDefault();
                    searchPersons();
                }
            });

            function searchPersons() {
                const keyword = personSearchInput.val().trim();
                if (!keyword) {
                    alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                $.ajax({
                    url: `/content/${contentId}/credit/search-person`,
                    type: 'GET',
                    data: { keyword: keyword },
                    dataType: 'json',
                    success: function(data) {
                        if (data.length === 0) {
                            personSearchResults.html('<div class="col-12"><p class="text-muted text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>');
                            return;
                        }
                        const resultsHtml = data.map(person => `
                        <div class="col-12 mb-3">
                            <div class="person-item cursor-pointer" data-person-id="${person.id}" data-person-name="${person.name}" onclick="window.selectPerson(${person.id}, '${person.name}')">
                                <div class="person-photo-container">
                                    <img src="${person.profile || '/images/default-profile.png'}" alt="${person.name}" class="person-photo">
                                </div>
                                <div class="person-info">
                                    <span class="person-name">${person.name}</span>
                                    <span class="person-role">${person.job || 'ì§ì—… ì •ë³´ ì—†ìŒ'}</span>
                                </div>
                            </div>
                        </div>`).join('');
                        personSearchResults.html(resultsHtml);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error fetching search results:', textStatus, errorThrown);
                        personSearchResults.html('<div class="col-12"><p class="text-danger text-center">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”)</p></div>');
                    }
                });
            }

            window.selectPerson = (id, name) => {
                personIdInput.val(id);
                fieldsAfterSearch.slideDown();
                departmentInput.focus();

                // ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ì—ì„œ ì„ íƒëœ ì•„ì´í…œë§Œ ê°•ì¡°
                $('#personSearchResults .person-item').removeClass('selected-person');
                $(`#personSearchResults .person-item[data-person-id="${id}"]`).addClass('selected-person');
            };

            creditForm.on('submit', function (event) {
                event.preventDefault();

                const url = `/content/${contentId}/credit`;
                const formData = $(this).serialize();

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    success: function() {
                        window.location.reload();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error saving credit:', textStatus, errorThrown);
                        alert('í¬ë ˆë”§ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            });

            /** ğŸ’¥ [ìˆ˜ì • ì™„ë£Œ] deleteCredit í•¨ìˆ˜: (ì™¸ë¶€ ì„œë¹„ìŠ¤ í¼ê³¼ ë™ì¼í•œ íŒ¨í„´ ì ìš©)
             * event ê°ì²´ë¥¼ ë°›ì•„ì„œ í•¨ìˆ˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ event.stopPropagation()ì„ í˜¸ì¶œí•˜ì—¬ ì¤‘ë³µ ì´ë²¤íŠ¸ ì‹¤í–‰ì„ ë°©ì§€í•©ë‹ˆë‹¤.
             */
            window.deleteCredit = (creditId, event) => {
                event.stopPropagation(); // â¬…ï¸ğŸ’¥ í•µì‹¬ ë¡œì§: ë¶€ëª¨ ìš”ì†Œì˜ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
                if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                $.ajax({
                    url: `/content/${contentId}/credit/delete`,
                    type: 'POST',
                    data: { creditId: creditId },
                    success: function() {
                        window.location.reload();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error deleting credit:', textStatus, errorThrown);
                        alert('í¬ë ˆë”§ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            };

            window.editCredit = (creditId) => {
                const creditToEdit = initialCreditList.find(c => c.id == creditId);
                if (!creditToEdit) return;

                resetForm();

                formTitle.text('í¬ë ˆë”§ ìˆ˜ì •');
                creditIdInput.val(creditToEdit.id);
                personIdInput.val(creditToEdit.person.id);
                departmentInput.val(creditToEdit.department);
                roleInput.val(creditToEdit.role);
                characterNameInput.val(creditToEdit.characterName);
                saveCreditBtn.text('ìˆ˜ì •');

                // ê²€ìƒ‰ì°½ ë° ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ ìˆ¨ê¸°ê¸°
                searchInputGroup.hide();
                personSearchResults.hide();

                // ì„ íƒëœ í¬ë ˆë”§ì—ë§Œ í…Œë‘ë¦¬ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                $(`.person-item[onclick*="editCredit(${creditId})"]`).addClass('selected-person');

                fieldsAfterSearch.show();
                creditFormSection.slideDown();
                showFormBtn.hide();
                departmentInput.focus();
            };

            function resetForm() {
                formTitle.text('í¬ë ˆë”§ ë“±ë¡');
                creditForm[0].reset();
                creditIdInput.val('');
                personIdInput.val('');
                personSearchInput.val('');
                personSearchResults.empty().show();
                fieldsAfterSearch.hide();
                saveCreditBtn.text('ë“±ë¡');
                $('.person-item').removeClass('selected-person');
                searchInputGroup.show();
            }

            /**
             * renderCreditList í•¨ìˆ˜:
             * deleteCredit í•¨ìˆ˜ì— event ê°ì²´ë¥¼ ì „ë‹¬í•˜ë©°, event.stopPropagation() ë¡œì§ì€ deleteCredit í•¨ìˆ˜ ì•ˆì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
             */
            function renderCreditList(credits) {
                if (!credits || credits.length === 0) {
                    creditListContainer.html('<div class="col-12"><p class="text-center text-muted">ë“±ë¡ëœ í¬ë ˆë”§ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>');
                    return;
                }
                const creditHtml = credits.map(credit => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="person-item cursor-pointer" onclick="window.editCredit(${credit.id})">
                        <div class="person-photo-container">
                            <img src="${credit.person?.profile || '/images/default-profile.png'}" alt="${credit.person.name}" class="person-photo">
                            <button type="button" class="btn btn-sm btn-light position-absolute top-0 end-0 p-0"
                                    style="width: 24px; height: 24px; line-height: 1; border-radius: 50%; display: flex; align-items: center; justify-content: center; transform: translate(50%, -50%);"

                                    /* ğŸ’¥ [ìµœì¢…] deleteCredit í•¨ìˆ˜ì— event ê°ì²´ë§Œ ì „ë‹¬ */
                                    onclick="window.deleteCredit(${credit.id}, event)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="person-info">
                            <span class="person-name">${credit.person.name}</span>
                            <span class="person-role">${credit.department} - ${credit.role}</span>
                        </div>
                    </div>
                </div>`).join('');

                creditListContainer.html(creditHtml);
            }
        });
    </script></main>
</body>
</html>